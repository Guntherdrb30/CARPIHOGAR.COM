datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  CLIENTE
  ALIADO
  VENDEDOR
  DESPACHO
  ARCHITECTO
  ADMIN
  DELIVERY
}

enum DesignProjectStatus {
  NUEVO
  EN_PROGRESO
  EN_REVISION
  EN_PAUSA
  ENTREGADO
  CANCELADO
}

enum DesignProjectStage {
  BRIEFING
  PROPUESTA
  RENDERS
  REVISION
  AJUSTES
  ENTREGA
}

enum DesignTaskStatus {
  PENDIENTE
  EN_PROGRESO
  BLOQUEADA
  COMPLETADA
}

enum AlliedStatus {
  NONE
  PENDING
  APPROVED
}

enum DeliveryStatus {
  NONE
  PENDING
  APPROVED
}

enum ProductType {
  SIMPLE
  GROUPED
  COMBO
}

enum ProductSoldBy {
  UNIT
  PACKAGE
  BOTH
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  REVIEW
  WHOLESALE_ONLY
  CLEARANCE
}

enum ProductFamily {
  STANDARD
  PARAMETRIC_FURNITURE
  KITCHEN_MODULE
}

enum KitchenCategory {
  LOW
  HIGH
  PANTRY
  TOWER
  FRIDGE
  CONDIMENT
  OTHER
}

enum KitchenLayoutType {
  LINEAL
  L_SHAPE
  DOUBLE_LINE
  LINEAL_WITH_ISLAND
  L_WITH_ISLAND
  L_WITH_PENINSULA
  CUSTOM_SPACE
}

enum KitchenDesignStatus {
  DRAFT
  SAVED
  ARCHIVED
}

enum Model3DAssetStatus {
  PENDING
  PROCESSING
  READY
  ERROR
}

enum Model3DJobStatus {
  PENDING
  PROCESSING
  DONE
  ERROR
}

// Sucursales físicas de la empresa (Barinas, otras ciudades)
model Branch {
  id               String   @id @default(cuid())
  name             String
  code             String   @unique
  state            String
  city             String
  address          String
  lat              Decimal? @db.Decimal(10, 7)
  lng              Decimal? @db.Decimal(10, 7)
  // Parámetros específicos de delivery para la sucursal (opcional, si no se usan se toman de SiteSettings)
  motoRatePerKmUSD Decimal? @db.Decimal(10, 4)
  carRatePerKmUSD  Decimal? @db.Decimal(10, 4)
  vanRatePerKmUSD  Decimal? @db.Decimal(10, 4)
  motoMinFeeUSD    Decimal? @db.Decimal(10, 2)
  vanMinFeeUSD     Decimal? @db.Decimal(10, 2)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  users     User[]
  shippings Shipping[]
}

model User {
  id                String       @id @default(cuid())
  email             String       @unique
  password          String
  name              String?
  phone             String?
  role              Role         @default(CLIENTE)
  alliedStatus      AlliedStatus @default(NONE)
  commissionPercent Decimal?     @db.Decimal(5, 2)
  // Ally profile fields (optional)
  profileImageUrl   String?
  bio               String?
  services          String[]
  portfolioUrls     String[]
  portfolioText     String?

  // Ally content relations
  news             News[]          @relation("UserNews")
  allyProjects     AllyProject[]   @relation("UserAllyProjects")
  createdAt        DateTime        @default(now())
  addresses        Address[]
  orders           Order[]         @relation("OrderCustomer")
  sellerOrders     Order[]         @relation("OrderSeller")
  reviewedOrders   Order[]         @relation("OrderReviewedBy")
  commissions      Commission[]
  commissionPayments CommissionPayment[] @relation("CommissionPaymentSeller")
  commissionPaymentsCreated CommissionPayment[] @relation("CommissionPaymentCreatedBy")
  quotes           Quote[]         @relation("QuoteCustomer")
  quotesAsSeller   Quote[]         @relation("QuoteSeller")
  createdPOs       PurchaseOrder[] @relation("POCreator")
  receivedPOs      PurchaseOrder[] @relation("POReceiver")
  wishlistItems    WishlistItem[]
  createdPurchases Purchase[]      @relation("PurchaseCreatedBy")

  // Delivery assignments (for DELIVERY role)
  deliveriesAssigned Shipping[] @relation("DeliveryAssignee")

  // Messaging relations
  conversations         Conversation[] @relation("ConversationUser")
  assignedConversations Conversation[] @relation("ConversationAssignedTo")

  // Back-relations for drivers and AI assistant cart
  driverLocations   DriverLocation[]
  assistantCarts    AssistantCart[]
  notifications     Notification[]
  pushSubscriptions PushSubscription[]

  // Moodboards creados por el usuario
  moodboards  Moodboard[]
  // Diseños personalizados del configurador ECPD
  ecpdDesigns EcpdDesign[]
  kitchenDesigns KitchenDesign[]
  adminSettingsAuditLogs AdminSettingsAuditLog[]
  designProjectsAssigned DesignProject[] @relation("DesignProjectArchitect")
  designProjectsCreated  DesignProject[] @relation("DesignProjectCreatedBy")
  designTasksAssigned    DesignProjectTask[] @relation("DesignTaskAssignee")
  designTasksCreated     DesignProjectTask[] @relation("DesignTaskCreatedBy")
  designUpdatesCreated   DesignProjectUpdate[] @relation("DesignProjectUpdateAuthor")
  designPaymentsCreated  DesignProjectPayment[] @relation("DesignProjectPaymentCreatedBy")
  designRendersCreated   DesignProjectRender[] @relation("DesignProjectRenderCreatedBy")

  passwordResetToken          String?   @unique
  passwordResetTokenExpiresAt DateTime?

  // Email verification
  emailVerifiedAt                 DateTime?
  emailVerificationToken          String?   @unique
  emailVerificationTokenExpiresAt DateTime?

  // Delivery registration fields
  deliveryStatus              DeliveryStatus @default(NONE)
  deliveryCedula              String?
  deliveryAddress             String?
  deliveryVehicleType         String?
  deliveryVehicleBrand        String?
  deliveryVehicleModel        String?
  deliveryMotoPlate           String?
  deliveryChassisSerial       String?
  deliveryIdImageUrl          String?
  deliverySelfieUrl           String?
  // Delivery contract acceptance
  deliveryAgreementAcceptedAt DateTime?
  deliveryAgreementVersion    Int?
  deliveryAgreementIp         String?
  // deliverySignedContractUrl   String?

  // Datos de pago para liquidaciones a delivery (transferencias / pago móvil)
  payoutBankName            String?
  payoutBankAccount         String?
  payoutBankIdNumber        String?
  payoutPmBank              String?
  payoutPmPhone             String?
  payoutPmIdNumber          String?
  deliverySignedContractUrl String?

  // Sucursal a la que pertenece el usuario (para controlar ventas y entregas por sucursal)
  branchId        String?
  branch          Branch?          @relation(fields: [branchId], references: [id])
  rootSecretSales RootSecretSale[] @relation("RootSecretSalesCreated")
  saleHoldsCreated SaleHold[] @relation("SaleHoldCreatedBy")
  saleHoldsAsSeller SaleHold[] @relation("SaleHoldSeller")
}

model DesignProject {
  id           String              @id @default(cuid())
  name         String
  clientName   String
  location     String
  architectId  String?
  architect    User?               @relation("DesignProjectArchitect", fields: [architectId], references: [id])
  priority     Int                 @default(5)
  startDate    DateTime?
  dueDate      DateTime?
  designTotalUSD Decimal?          @db.Decimal(12, 2)
  status       DesignProjectStatus @default(NUEVO)
  stage        DesignProjectStage  @default(BRIEFING)
  description  String?
  initialMeasurements String?
  referenceImages String[]         @default([])
  createdById  String?
  createdBy    User?               @relation("DesignProjectCreatedBy", fields: [createdById], references: [id])
  tasks        DesignProjectTask[]
  updates      DesignProjectUpdate[]
  payments     DesignProjectPayment[]
  renders      DesignProjectRender[]
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  @@index([architectId, status])
  @@index([status, dueDate])
}

model DesignProjectTask {
  id            String            @id @default(cuid())
  projectId     String
  project       DesignProject     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  title         String
  assignedToId  String?
  assignedTo    User?             @relation("DesignTaskAssignee", fields: [assignedToId], references: [id])
  dueDate       DateTime?
  priority      Int               @default(5)
  status        DesignTaskStatus  @default(PENDIENTE)
  comments      String?
  createdById   String?
  createdBy     User?             @relation("DesignTaskCreatedBy", fields: [createdById], references: [id])
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([projectId, status])
  @@index([assignedToId, dueDate])
}

model DesignProjectUpdate {
  id          String        @id @default(cuid())
  projectId   String
  project     DesignProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  note        String?
  fileUrl     String?
  createdById String?
  createdBy   User?         @relation("DesignProjectUpdateAuthor", fields: [createdById], references: [id])
  createdAt   DateTime      @default(now())

  @@index([projectId, createdAt])
}

model DesignProjectPayment {
  id          String        @id @default(cuid())
  projectId   String
  project     DesignProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  amountUSD   Decimal       @db.Decimal(12, 2)
  paidAt      DateTime
  method      PaymentMethod?
  reference   String?
  fileUrl     String?
  createdById String?
  createdBy   User?         @relation("DesignProjectPaymentCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime      @default(now())

  @@index([projectId, paidAt])
}

model DesignProjectRender {
  id             String        @id @default(cuid())
  projectId      String
  project        DesignProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  prompt         String
  sourceImageUrl String
  outputImageUrl String
  createdById    String?
  createdBy      User?         @relation("DesignProjectRenderCreatedBy", fields: [createdById], references: [id])
  createdAt      DateTime      @default(now())

  @@index([projectId, createdAt])
}

model SiteSettings {
  id                           Int       @id @default(1)
  brandName                    String    @default("Carpihogar.ai")
  whatsappPhone                String
  contactPhone                 String
  contactEmail                 String
  ivaPercent                   Decimal   @default(16) @db.Decimal(5, 2)
  tasaVES                      Decimal   @default(40) @db.Decimal(10, 2)
  primaryColor                 String?
  secondaryColor               String?
  logoUrl                      String?
  homeHeroUrls                 String[]
  // Hero específico para la experiencia de moodboard
  moodboardHeroUrls            String[]
  // Mini hero para el personalizador de muebles (ECPD)
  ecpdHeroUrls                 String[]
  // Paleta de colores para el personalizador (JSON con nombre, imagen, descripcion)
  ecpdColors                   Json?
  heroAutoplayMs               Int?
  lowStockThreshold            Int       @default(5)
  slaWarningDays               Decimal?  @default(7) @db.Decimal(6, 2)
  slaCriticalOverdueDays       Decimal?  @default(3) @db.Decimal(6, 2)
  sellerCommissionPercent      Decimal   @default(5) @db.Decimal(5, 2)
  deleteSecret                 String?
  // Social handles for product buttons
  instagramHandle              String?
  tiktokHandle                 String?
  // Background images for Featured Categories (Home)
  categoryBannerCarpinteriaUrl String?
  categoryBannerHogarUrl       String?
  // Root recovery and security settings (root-only)
  rootPhone                    String?
  rootRecoveryHash             String?
  rootResetCode                String?
  rootResetCodeExpiresAt       DateTime?
  // Defaults for product margins (root configurable)
  defaultMarginClientPct       Decimal?  @db.Decimal(5, 2)
  defaultMarginAllyPct         Decimal?  @db.Decimal(5, 2)
  defaultMarginWholesalePct    Decimal?  @db.Decimal(5, 2)
  // Motor de ajustes de precio (root-only)
  globalPriceAdjustmentPercent   Decimal? @default(0) @db.Decimal(6, 2)
  globalPriceAdjustmentEnabled   Boolean  @default(false)
  priceAdjustmentUSDPercent      Decimal? @default(0) @db.Decimal(6, 2)
  priceAdjustmentVESPercent      Decimal? @default(0) @db.Decimal(6, 2)
  priceAdjustmentByCurrencyEnabled Boolean @default(false)
  categoryPriceAdjustments        Json?
  usdPaymentDiscountPercent       Decimal? @default(20) @db.Decimal(6, 2)
  usdPaymentDiscountEnabled       Boolean  @default(true)
  // Bloqueo global de ventas en bolivares (root-only)
  vesSalesDisabled                Boolean  @default(false)

  // Payment instructions (root-configurable)
  paymentZelleEmail       String?
  paymentPmPhone          String?
  paymentPmRif            String?
  paymentPmBank           String?
  paymentBanescoAccount   String?
  paymentBanescoRif       String?
  paymentBanescoName      String?
  paymentMercantilAccount String?
  paymentMercantilRif     String?
  paymentMercantilName    String?
  // Legal / billing data for invoices (root-only)
  legalCompanyName        String?
  legalCompanyRif         String?
  legalCompanyAddress     String?
  legalCompanyPhone       String?

  // Parámetros globales para delivery local (pueden servir como defaults por sucursal)
  deliveryMotoRatePerKmUSD Decimal? @db.Decimal(10, 4) // ej: 0.5 USD/km
  deliveryCarRatePerKmUSD  Decimal? @db.Decimal(10, 4) // ej: 0.75 USD/km
  deliveryVanRatePerKmUSD  Decimal? @db.Decimal(10, 4) // ej: 1 USD/km
  deliveryMotoMinFeeUSD    Decimal? @db.Decimal(10, 2) // ej: mínimo 4 USD
  deliveryVanMinFeeUSD     Decimal? @db.Decimal(10, 2) // ej: mínimo 10 USD
  deliveryDriverSharePct   Decimal? @db.Decimal(5, 2) // ej: 70
  deliveryCompanySharePct  Decimal? @db.Decimal(5, 2) // ej: 30
  invoiceNextNumber        Int?     @default(1)
  receiptNextNumber        Int?     @default(1)
}

model Category {
  id        String     @id @default(cuid())
  name      String
  slug      String     @unique
  createdAt DateTime   @default(now())
  parentId  String?
  parent    Category?  @relation("CategoryChildren", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryChildren")
  products  Product[]
}

model Product {
  id                String   @id @default(cuid())
  name              String
  slug              String   @unique
  brand             String
  description       String?
  images            String[]
  // Optional product video (rendered last in gallery)
  videoUrl          String?
  // Show Instagram/TikTok buttons in PDP
  showSocialButtons Boolean  @default(false)
  // Base catalog activation
  isActive          Boolean  @default(true)
  basePriceUsd      Decimal  @default(0) @db.Decimal(10, 2)
  productFamily     ProductFamily @default(STANDARD)
  kitchenCategory   KitchenCategory?
  isVisibleInKitchenDesigner Boolean @default(false)
  usableInQuickBudget Boolean @default(false)
  usableInKitchenDesigner Boolean @default(false)
  isParametric      Boolean  @default(false)
  widthMm           Int?
  heightMm          Int?
  depthMm           Int?
  widthMinMm        Int?
  widthMaxMm        Int?
  heightMinMm       Int?
  heightMaxMm       Int?
  parametricPricingFormula String?
  // ECPD: marca si el producto tiene configurador de muebles asociado
  isConfigurable    Boolean  @default(false)
  // ECPD: esquema JSON del configurador (dimensiones, componentes, etc.)
  configSchema      Json?
  sku               String?  @unique
  // Câ”œâ”‚digo interno opcional (puede venir de proveedor)
  code              String?  @unique
  supplierCode      String?
  // Palabras clave SEO / búsqueda
  keywords          String[] @default([])
  // Modelo y garantía
  model             String?
  guarantee         String?

  // Tipo de producto (simple / agrupado / combo)
  type               ProductType   @default(SIMPLE)
  priceUSD           Decimal       @db.Decimal(10, 2)
  priceAllyUSD       Decimal?      @db.Decimal(10, 2)
  // Nuevo: Precio mayorista (calculado)
  priceWholesaleUSD  Decimal?      @db.Decimal(10, 2)
  // Kitchen designer price tiers (optional, only for kitchen modules)
  kitchenPriceLowUsd  Decimal?     @db.Decimal(10, 2)
  kitchenPriceMidUsd  Decimal?     @db.Decimal(10, 2)
  kitchenPriceHighUsd Decimal?     @db.Decimal(10, 2)
  // Nuevo: costos y mâ”œÃ­rgenes de referencia
  costUSD            Decimal?      @db.Decimal(10, 2)
  marginClientPct    Decimal?      @db.Decimal(5, 2)
  marginAllyPct      Decimal?      @db.Decimal(5, 2)
  marginWholesalePct Decimal?      @db.Decimal(5, 2)
  // Nuevo: precios calculados explâ”œÂ¡citos (el priceUSD existente se usa como Cliente)
  priceClientUSD     Decimal?      @db.Decimal(10, 2)
  // Inventario principal
  stock              Int           @default(0)
  // Stock en unidades (alias más explícito para stock)
  stockUnits         Int           @default(0)
  // Stock mínimo recomendado
  stockMinUnits      Int           @default(0)
  // Permitir venta por pedido / backorder (solo ERP)
  allowBackorder     Boolean       @default(false)
  // Permitir venta por unidad cuando es agrupado
  allowUnitSale      Boolean       @default(true)
  // Configuración para productos agrupados (cajas/paquetes)
  unitsPerPackage    Int?
  stockPackages      Int?
  soldBy             ProductSoldBy @default(UNIT)

  // Datos de envío / flete
  weightKg                Decimal? @db.Decimal(10, 3)
  heightCm                Decimal? @db.Decimal(10, 2)
  widthCm                 Decimal? @db.Decimal(10, 2)
  depthCm                 Decimal? @db.Decimal(10, 2)
  volumeCm3               Decimal? @db.Decimal(12, 2)
  freightType             String?
  // Tipos de delivery que pueden transportar este producto (MOTO, CARRO, CAMIONETA)
  deliveryAllowedVehicles String[] @default([])

  // Estado del producto
  status ProductStatus @default(ACTIVE)

  supplierId         String?
  supplier           Supplier?           @relation(fields: [supplierId], references: [id])
  reorderPoint       Int?
  safetyStock        Int?
  leadTimeDays       Int?
  costMethod         CostMethod          @default(PROMEDIO)
  avgCost            Decimal?            @db.Decimal(10, 2)
  lastCost           Decimal?            @db.Decimal(10, 2)
  categoryId         String?
  category           Category?           @relation(fields: [categoryId], references: [id])
  isNew              Boolean             @default(false)
  // Marcador interno: solo root puede vender sin IVA
  rootNoIvaOnly      Boolean             @default(false)
  createdAt          DateTime            @default(now())
  barcode            String?             @unique
  orderItems         OrderItem[]
  stockMoves         StockMovement[]
  purchaseOrderItems PurchaseOrderItem[]
  quoteItems         QuoteItem[]
  wishlistItems      WishlistItem[]
  purchaseItems      PurchaseItem[]
  // Self-referencing many-to-many for related products
  relatedFrom        RelatedProduct[]    @relation("RelatedFrom")
  relatedTo          RelatedProduct[]    @relation("RelatedTo")

  // Back-relation to assistant cart items
  assistantCartItems  AssistantCartItem[]
  // Diseños personalizados vinculados a este producto
  ecpdDesigns         EcpdDesign[]
  kitchenModules      KitchenModule[]
  // Ventas secretas de root asociadas
  rootSecretSaleItems RootSecretSaleItem[]
  model3dAssets       Model3DAsset[]
}

// Join table for Product <-> Product related items
model RelatedProduct {
  fromId    String
  toId      String
  from      Product  @relation("RelatedFrom", fields: [fromId], references: [id], onDelete: Cascade)
  to        Product  @relation("RelatedTo", fields: [toId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@id([fromId, toId])
}

enum OrderStatus {
  PENDIENTE
  CONFIRMACION
  PAGADO
  ENVIADO
  COMPLETADO
  CANCELADO
}

// Tipo de venta
enum SaleType {
  CONTADO
  CREDITO
}

enum OrderDocumentType {
  RECIBO
  FACTURA
}

enum PaymentMethod {
  PAGO_MOVIL
  TRANSFERENCIA
  ZELLE
  EFECTIVO
}

enum PaymentStatus {
  SIN_PRUEBA
  EN_REVISION
  RECHAZADO
  APROBADO
}

enum Currency {
  USD
  VES
  USDT
}

model Address {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  fullname  String
  phone     String
  state     String
  city      String
  zone      String?
  address1  String
  address2  String?
  lat       Decimal? @db.Decimal(10, 7)
  lng       Decimal? @db.Decimal(10, 7)
  notes     String?
  createdAt DateTime @default(now())
  orders    Order[]
}

model Order {
  id                    String      @id @default(cuid())
  userId                String
  user                  User        @relation("OrderCustomer", fields: [userId], references: [id])
  sellerId              String?
  seller                User?       @relation("OrderSeller", fields: [sellerId], references: [id])
  items                 OrderItem[]
  subtotalUSD           Decimal     @db.Decimal(10, 2)
  ivaPercent            Decimal     @db.Decimal(5, 2)
  tasaVES               Decimal     @db.Decimal(10, 2)
  totalUSD              Decimal     @db.Decimal(10, 2)
  totalVES              Decimal     @db.Decimal(12, 2)
  payment               Payment?
  createdAt             DateTime    @default(now())
  status                OrderStatus @default(PENDIENTE)
  saleType              SaleType    @default(CONTADO)
  // Legal correlatives for receipts/invoices (assigned at first PDF generation)
  invoiceNumber         Int?
  receiptNumber         Int?
  // Origen de la venta (ONLINE = web, ERP = cargada por admin/aliado)
  originChannel         String?     @default("ONLINE")
  // Control interno de revisión administrativa
  reviewedAt            DateTime?
  reviewedById          String?
  reviewedBy            User?       @relation("OrderReviewedBy", fields: [reviewedById], references: [id])
  creditDueDate         DateTime?
  shippingAddressId     String?
  shippingAddress       Address?    @relation(fields: [shippingAddressId], references: [id])
  shipping              Shipping?
  commission            Commission?
  receivable            Receivable?
  customerTaxId         String?
  customerFiscalAddress String?
  // Vincula la orden con un presupuesto origen (si aplica)
  originQuoteId         String?
  // Tipo de documento generado para esta venta (recibo o factura)
  documentType          OrderDocumentType?

  // Back-relation to order auth tokens (WhatsApp confirmation)
  authTokens OrderAuthToken[]
}

model SaleHold {
  id                     String   @id @default(cuid())
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  createdById            String?
  createdBy              User?    @relation("SaleHoldCreatedBy", fields: [createdById], references: [id])
  sellerId               String?
  seller                 User?    @relation("SaleHoldSeller", fields: [sellerId], references: [id])
  customerName           String?
  customerEmail          String?
  customerPhone          String?
  customerTaxId          String?
  customerFiscalAddress  String?
  items                  Json
  meta                   Json?
  totalUSD               Decimal? @db.Decimal(12, 2)

  @@index([createdById])
  @@index([sellerId])
  @@index([createdAt])
}

// Ventas internas del usuario root (sin IVA, no afectan registro normal)
model RootSecretSale {
  id                    String               @id @default(cuid())
  noteNumber            Int                  @unique @default(autoincrement())
  createdAt             DateTime             @default(now())
  createdById           String?
  createdBy             User?                @relation("RootSecretSalesCreated", fields: [createdById], references: [id])
  customerName          String?
  customerPhone         String?
  customerTaxId         String?
  customerFiscalAddress String?
  observations          String?
  subtotalUSD           Decimal              @db.Decimal(10, 2)
  totalUSD              Decimal              @db.Decimal(10, 2)
  tasaVES               Decimal?             @db.Decimal(10, 2)
  currency              Currency             @default(USD)
  withoutIva            Boolean              @default(true)
  items                 RootSecretSaleItem[]
}

model RootSecretSaleItem {
  id         String         @id @default(cuid())
  saleId     String
  sale       RootSecretSale @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId  String
  product    Product        @relation(fields: [productId], references: [id])
  name       String
  quantity   Int
  priceUSD   Decimal        @db.Decimal(10, 2)
  withoutIva Boolean        @default(true)
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])
  name      String
  priceUSD  Decimal @db.Decimal(10, 2)
  quantity  Int
}

model Payment {
  id         String        @id @default(cuid())
  orderId    String        @unique
  order      Order         @relation(fields: [orderId], references: [id])
  method     PaymentMethod
  proofUrl   String?
  reference  String?
  status     PaymentStatus @default(SIN_PRUEBA)
  currency   Currency      @default(USD)
  payerName  String?
  payerPhone String?
  payerBank  String?
  payerId    String?
  createdAt  DateTime      @default(now())
}

enum CommissionStatus {
  PENDIENTE
  PAGADA
}

model Commission {
  id        String           @id @default(cuid())
  orderId   String           @unique
  order     Order            @relation(fields: [orderId], references: [id])
  sellerId  String
  seller    User             @relation(fields: [sellerId], references: [id])
  percent   Decimal          @db.Decimal(5, 2)
  amountUSD Decimal          @db.Decimal(10, 2)
  status    CommissionStatus @default(PENDIENTE)
  createdAt DateTime         @default(now())
}

model CommissionPayment {
  id           String        @id @default(cuid())
  sellerId     String
  seller       User          @relation("CommissionPaymentSeller", fields: [sellerId], references: [id])
  amount       Decimal       @db.Decimal(12, 2)
  currency     Currency      @default(USD)
  method       PaymentMethod
  reference    String?
  bankName     String?
  paidAt       DateTime
  paidByName   String?
  proofUrl     String?
  createdAt    DateTime      @default(now())
  createdById  String?
  createdBy    User?         @relation("CommissionPaymentCreatedBy", fields: [createdById], references: [id])

  @@index([sellerId, paidAt])
  @@index([reference])
}

enum QuoteStatus {
  BORRADOR
  ENVIADO
  APROBADO
  RECHAZADO
  VENCIDO
}

model Quote {
  id                    String      @id @default(cuid())
  userId                String
  user                  User        @relation("QuoteCustomer", fields: [userId], references: [id])
  sellerId              String?
  seller                User?       @relation("QuoteSeller", fields: [sellerId], references: [id])
  items                 QuoteItem[]
  subtotalUSD           Decimal     @db.Decimal(10, 2)
  ivaPercent            Decimal     @db.Decimal(5, 2)
  tasaVES               Decimal     @db.Decimal(10, 2)
  totalUSD              Decimal     @db.Decimal(10, 2)
  totalVES              Decimal     @db.Decimal(12, 2)
  status                QuoteStatus @default(BORRADOR)
  expiresAt             DateTime?
  notes                 String?
  customerTaxId         String?
  customerFiscalAddress String?
  createdAt             DateTime    @default(now())
}

model QuoteItem {
  id        String  @id @default(cuid())
  quoteId   String
  quote     Quote   @relation(fields: [quoteId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])
  name      String
  priceUSD  Decimal @db.Decimal(10, 2)
  quantity  Int
}

enum StockMoveType {
  ENTRADA
  SALIDA
  AJUSTE
}

enum CostMethod {
  PROMEDIO
  FIFO
}

model StockMovement {
  id        String        @id @default(cuid())
  productId String
  product   Product       @relation(fields: [productId], references: [id])
  type      StockMoveType
  quantity  Int
  reason    String?
  userId    String?
  createdAt DateTime      @default(now())
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  details   String?
  projectId String?
  createdAt DateTime @default(now())

  @@index([projectId, createdAt])
}

model AdminSettingsAuditLog {
  id               String   @id @default(cuid())
  settingKey       String
  oldValue         String?
  newValue         String?
  changedByUserId  String?
  changedBy        User?    @relation(fields: [changedByUserId], references: [id])
  changedAt        DateTime @default(now())
  ipAddress        String?
  userAgent        String?

  @@index([changedAt])
  @@index([settingKey])
}

// Evidencias de envíos (fotos y firma)
model ShipmentPhoto {
  id         String   @id @default(cuid())
  shipmentId String
  shipment   Shipping @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  // package | delivered | signature
  type       String
  url        String
  createdAt  DateTime @default(now())

  @@index([shipmentId])
}

// Ubicaciones de repartidores (última posición conocida)
model DriverLocation {
  id        String   @id @default(cuid())
  driverId  String
  driver    User     @relation(fields: [driverId], references: [id], onDelete: Cascade)
  lat       Decimal  @db.Decimal(10, 7)
  lng       Decimal  @db.Decimal(10, 7)
  updatedAt DateTime @default(now())

  @@index([driverId])
}

model Supplier {
  id             String          @id @default(cuid())
  name           String
  email          String?
  phone          String?
  taxId          String?
  address        String?
  // URL pública a la imagen/scan del RIF
  rifImageUrl    String?
  // Persona de contacto principal
  contactName    String?
  contactPhone   String?
  // Moneda de cobro del proveedor (USD/VES)
  chargeCurrency Currency        @default(USD)
  // Condiciones de crédito
  givesCredit    Boolean         @default(false)
  creditDays     Int?
  createdAt      DateTime        @default(now())
  purchaseOrders PurchaseOrder[]
  purchases      Purchase[]
  products       Product[]
}

enum POStatus {
  DRAFT
  ORDERED
  RECEIVED
  CANCELLED
}

enum PurchaseType {
  CONTADO
  PARCIAL
  CREDITO
}

model PurchaseOrder {
  id           String              @id @default(cuid())
  supplierId   String
  supplier     Supplier            @relation(fields: [supplierId], references: [id])
  status       POStatus            @default(DRAFT)
  expectedAt   DateTime?
  purchaseType PurchaseType        @default(CONTADO)
  totalUSD     Decimal             @default(0) @db.Decimal(12, 2)
  notes        String?
  createdAt    DateTime            @default(now())
  items        PurchaseOrderItem[]
  createdById  String?
  createdBy    User?               @relation("POCreator", fields: [createdById], references: [id])
  receivedById String?
  receivedBy   User?               @relation("POReceiver", fields: [receivedById], references: [id])
  receivedAt   DateTime?
}

model PurchaseOrderItem {
  id        String        @id @default(cuid())
  poId      String
  po        PurchaseOrder @relation(fields: [poId], references: [id])
  productId String
  product   Product       @relation(fields: [productId], references: [id])
  quantity  Int
  received  Int           @default(0)
  costUSD   Decimal       @db.Decimal(10, 2)
}

// Compras (factura recibida)
model Purchase {
  id                String            @id @default(cuid())
  supplierId        String?
  supplier          Supplier?         @relation(fields: [supplierId], references: [id])
  currency          Currency          @default(USD)
  tasaVES           Decimal           @default(0) @db.Decimal(10, 2)
  subtotalUSD       Decimal           @default(0) @db.Decimal(12, 2)
  totalUSD          Decimal           @default(0) @db.Decimal(12, 2)
  // Datos legales de la factura del proveedor
  invoiceNumber     String?
  invoiceDate       DateTime?
  baseAmountUSD     Decimal?          @db.Decimal(12, 2)
  discountPercent   Decimal?          @db.Decimal(5, 2)
  discountAmountUSD Decimal?          @db.Decimal(12, 2)
  ivaPercent        Decimal?          @db.Decimal(5, 2)
  ivaAmountUSD      Decimal?          @db.Decimal(12, 2)
  // IGTF sobre pagos en divisas
  igtfPercent       Decimal?          @db.Decimal(5, 2)
  igtfAmountUSD     Decimal?          @db.Decimal(12, 2)
  itemsCount        Int?
  // Soporte de la factura (imagen/PDF subida)
  invoiceImageUrl   String?
  notes             String?
  createdAt         DateTime          @default(now())
  createdById       String?
  createdBy         User?             @relation("PurchaseCreatedBy", fields: [createdById], references: [id])
  items             PurchaseItem[]
  bankTransactions  BankTransaction[]
}

model PurchaseItem {
  id          String   @id @default(cuid())
  purchaseId  String
  purchase    Purchase @relation(fields: [purchaseId], references: [id])
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  name        String
  quantity    Int
  costUSD     Decimal  @db.Decimal(10, 2)
  subtotalUSD Decimal  @db.Decimal(12, 2)
}

// Bancos y movimientos para conciliación básica de pagos
enum BankTransactionType {
  DEBITO
  CREDITO
}

model BankAccount {
  id             String            @id @default(cuid())
  name           String
  bankName       String?
  accountNumber  String?
  currency       Currency          @default(USD)
  initialBalance Decimal           @default(0) @db.Decimal(14, 2)
  isActive       Boolean           @default(true)
  createdAt      DateTime          @default(now())
  transactions   BankTransaction[]
}

model BankTransaction {
  id            String              @id @default(cuid())
  bankAccountId String
  bankAccount   BankAccount         @relation(fields: [bankAccountId], references: [id])
  type          BankTransactionType
  amount        Decimal             @db.Decimal(14, 2)
  currency      Currency            @default(USD)
  description   String?
  reference     String?
  purchaseId    String?
  purchase      Purchase?           @relation(fields: [purchaseId], references: [id])
  createdAt     DateTime            @default(now())
}

// Cuentas por pagar a proveedores
enum PayableStatus {
  PENDIENTE
  PARCIAL
  PAGADO
  CANCELADO
}

model Payable {
  id         String         @id @default(cuid())
  purchaseId String         @unique
  supplierId String?
  status     PayableStatus  @default(PENDIENTE)
  totalUSD   Decimal        @db.Decimal(12, 2)
  balanceUSD Decimal        @db.Decimal(12, 2)
  dueDate    DateTime?
  notes      String?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  entries    PayableEntry[]
}

model PayableEntry {
  id            String         @id @default(cuid())
  payableId     String
  payable       Payable        @relation(fields: [payableId], references: [id])
  amountUSD     Decimal        @db.Decimal(12, 2)
  currency      Currency       @default(USD)
  method        PaymentMethod?
  bankAccountId String?
  reference     String?
  notes         String?
  createdAt     DateTime       @default(now())
}

enum ShippingCarrier {
  TEALCA
  MRW
  FLETE_PRIVADO
  RETIRO_TIENDA
  DELIVERY
  OTRO
}

enum ShippingStatus {
  PENDIENTE
  PREPARANDO
  DESPACHADO
  EN_TRANSITO
  ENTREGADO
  INCIDENCIA
}

enum ShippingChannel {
  ONLINE
  TIENDA
}

enum PayrollEmployeeType {
  FIJA
  CONTRATADA
}

enum PayrollPaymentCategory {
  NOMINA_FIJA
  NOMINA_CONTRATADA
  OTRO
  CARPINTERIA
}

enum CarpentryProjectStatus {
  ACTIVO
  EN_PROCESO
  CERRADO
}

enum CarpentryProjectFileType {
  PLANO
  IMAGEN
  CONTRATO
  PRESUPUESTO
  AVANCE
  OTRO
}

enum CarpentryProjectPhase {
  FABRICACION
  INSTALACION
}

enum CarpentryTaskStatus {
  PENDIENTE
  EN_PROGRESO
  COMPLETADA
}

model Shipping {
  id                  String          @id @default(cuid())
  orderId             String          @unique
  order               Order           @relation(fields: [orderId], references: [id])
  carrier             ShippingCarrier
  tracking            String?
  status              ShippingStatus  @default(PENDIENTE)
  channel             ShippingChannel @default(TIENDA)
  observations        String?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  assignedToId        String?
  assignedTo          User?           @relation("DeliveryAssignee", fields: [assignedToId], references: [id])
  assignedAt          DateTime?
  // Sucursal desde la que se gestiona este envío (origen logístico)
  branchId            String?
  branch              Branch?         @relation(fields: [branchId], references: [id])
  deliveryFeeUSD      Decimal?        @db.Decimal(10, 2)
  deliveryPaidAt      DateTime?
  // Delivery local (moto): confirmaciones, valoraciones y propinas
  clientConfirmedAt   DateTime?
  deliveryConfirmedAt DateTime?
  clientRating        Int?
  deliveryRating      Int?
  tipUSD              Decimal?        @db.Decimal(10, 2)

  // Back-relation to shipment evidences (photos/signature)
  photos ShipmentPhoto[]
}

// Estado de cuentas por cobrar
enum ReceivableStatus {
  PENDIENTE
  PARCIAL
  PAGADO
  CANCELADO
}

enum ReceivableNoteType {
  CREDITO
  DEBITO
}

model Receivable {
  id        String            @id @default(cuid())
  orderId   String            @unique
  order     Order             @relation(fields: [orderId], references: [id])
  status    ReceivableStatus  @default(PENDIENTE)
  dueDate   DateTime?
  notes     String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  entries   ReceivableEntry[]
  noteItems ReceivableNote[]
}

model ReceivableEntry {
  id           String         @id @default(cuid())
  receivableId String
  receivable   Receivable     @relation(fields: [receivableId], references: [id])
  amountUSD    Decimal        @db.Decimal(12, 2)
  currency     Currency       @default(USD)
  method       PaymentMethod?
  reference    String?
  notes        String?
  createdAt    DateTime       @default(now())
}

model ReceivableNote {
  id           String             @id @default(cuid())
  receivableId String
  receivable   Receivable         @relation(fields: [receivableId], references: [id])
  type         ReceivableNoteType
  amountUSD    Decimal            @db.Decimal(12, 2)
  reason       String?
  createdAt    DateTime           @default(now())
}

model WishlistItem {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, productId])
}

// Messaging (WhatsApp)
enum Channel {
  WHATSAPP
}

enum MessageDirection {
  IN
  OUT
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
  FAILED
}

enum ConversationStatus {
  OPEN
  IN_PROGRESS
  PENDING
  RESOLVED
  CLOSED
}

model Conversation {
  id             String             @id @default(cuid())
  userId         String?
  user           User?              @relation("ConversationUser", fields: [userId], references: [id])
  phone          String
  channel        Channel            @default(WHATSAPP)
  assignedToId   String?
  assignedTo     User?              @relation("ConversationAssignedTo", fields: [assignedToId], references: [id])
  status         ConversationStatus @default(OPEN)
  assignedAt     DateTime?
  closedAt       DateTime?
  lastInboundAt  DateTime?
  lastOutboundAt DateTime?
  unreadAgent    Int                @default(0)
  unreadCustomer Int                @default(0)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  lastMessageAt  DateTime?
  messages       Message[]
  aiHandled      Boolean            @default(false)

  @@index([userId])
  @@index([phone])
  @@index([lastMessageAt])
}

model Message {
  id             String           @id @default(cuid())
  conversationId String
  conversation   Conversation     @relation(fields: [conversationId], references: [id])
  direction      MessageDirection
  status         MessageStatus    @default(SENT)
  type           String           @default("TEXT")
  text           String?
  mediaUrl       String?
  waMessageId    String?
  actor          MessageActor?
  metadata       Json?
  createdAt      DateTime         @default(now())

  @@index([conversationId, createdAt])
}

enum MessageActor {
  CUSTOMER
  AGENT
  AI
}

// Noticias generadas a partir de proyectos de aliados
model News {
  id        String   @id @default(cuid())
  authorId  String
  author    User     @relation("UserNews", fields: [authorId], references: [id])
  imageUrl  String
  title     String?
  excerpt   String?
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([authorId, createdAt])
}

// Cursos (creaciÃ³n y monetizaciÃ³n)
enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model Course {
  id           String       @id @default(cuid())
  slug         String       @unique
  title        String
  topic        String
  summary      String?
  curriculum   Json?
  priceUSD     Decimal      @db.Decimal(10, 2)
  status       CourseStatus @default(DRAFT)
  heroImageUrl String?
  videoUrl     String?
  saleStartAt  DateTime?
  saleEndAt    DateTime?
  createdAt    DateTime     @default(now())

  @@index([status, createdAt])
}

// Proyectos de aliados: se guardan solo los 2 mâ”œÃ­s recientes
model AllyProject {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation("UserAllyProjects", fields: [userId], references: [id], onDelete: Cascade)
  images    String[]
  videoUrl  String?
  caption   String?
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
}

// Assistant cart (AI concierge controlled)
model AssistantCart {
  id        String              @id @default(cuid())
  ownerKey  String // sessionId or customerId
  userId    String?
  user      User?               @relation(fields: [userId], references: [id])
  items     AssistantCartItem[]
  createdAt DateTime            @default(now())
  updatedAt DateTime            @default(now())

  @@index([ownerKey])
}

model AssistantCartItem {
  id        String        @id @default(cuid())
  cartId    String
  cart      AssistantCart @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product   Product       @relation(fields: [productId], references: [id])
  name      String
  priceUSD  Decimal       @db.Decimal(10, 2)
  quantity  Int
  createdAt DateTime      @default(now())

  @@unique([cartId, productId])
}

model Moodboard {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  jsonData  Json
  thumbnail String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, updatedAt])
}

// Diseños de muebles personalizados (ECPD) guardados por el cliente
model EcpdDesign {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId       String
  product         Product  @relation(fields: [productId], references: [id])
  // Imagen del espacio subida por el cliente
  spaceImageUrl   String
  // Configuración completa del mueble (dimensiones, componentes, estética)
  config          Json
  // Posición relativa del mueble sobre la foto (0-1, centro)
  overlayX        Float    @default(0.5)
  overlayY        Float    @default(0.5)
  // Escala visual adicional aplicada sobre la escala derivada de las dimensiones reales
  overlayScale    Float    @default(1)
  // Rotación visual en grados
  overlayRotation Float    @default(0)
  // Precio en el momento de guardar
  priceUSD        Decimal  @db.Decimal(10, 2)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId, createdAt])
}

// Diseños guardados del creador de cocinas
model KitchenDesign {
  id            String              @id @default(cuid())
  userId        String
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String
  layoutType    KitchenLayoutType
  status        KitchenDesignStatus @default(DRAFT)
  totalPriceUsd Decimal             @default(0) @db.Decimal(12, 2)
  planJson      Json?
  modulesJson   Json?
  budgetJson    Json?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  spaces        KitchenSpace[]
  kitchenModules KitchenModule[]

  @@index([userId, updatedAt])
  @@index([userId, status])
}

model KitchenSpace {
  id        String        @id @default(cuid())
  kitchenId String
  kitchen   KitchenDesign @relation(fields: [kitchenId], references: [id], onDelete: Cascade)
  wallName  String
  widthMm   Int
  heightMm  Int?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@unique([kitchenId, wallName])
  @@index([kitchenId])
}

model KitchenModule {
  id                 String        @id @default(cuid())
  kitchenId          String
  kitchen            KitchenDesign @relation(fields: [kitchenId], references: [id], onDelete: Cascade)
  productId          String
  product            Product       @relation(fields: [productId], references: [id])
  positionX          Int
  positionY          Int
  widthMm            Int
  depthMm            Int
  lockedHeight       Int
  priceCalculatedUsd Decimal       @db.Decimal(12, 2)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  @@index([kitchenId])
  @@index([productId])
}

// 3D model assets for products
model Model3DAsset {
  id                   String             @id @default(cuid())
  productId            String
  product              Product            @relation(fields: [productId], references: [id], onDelete: Cascade)
  status               Model3DAssetStatus @default(PENDING)
  originalFileName     String
  originalFileMime     String
  originalFileTempPath String?
  glbPath              String?
  previewImagePath     String?
  processingError      String?
  archived             Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  jobs                 Model3DJob[]

  @@index([productId])
}

// 3D conversion job queue
model Model3DJob {
  id             String           @id @default(cuid())
  model3dAssetId String
  model3dAsset   Model3DAsset     @relation(fields: [model3dAssetId], references: [id], onDelete: Cascade)
  status         Model3DJobStatus @default(PENDING)
  attempts       Int              @default(0)
  lastError      String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([model3dAssetId])
}

// Notificaciones internas (drivers, clientes, etc.)
model Notification {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String
  title     String
  body      String
  data      Json?
  readAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId, createdAt])
}

// Suscripciones Web Push por dispositivo
model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint  String   @unique
  data      Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// Nomina y pagos
model PayrollEmployee {
  id          String              @id @default(cuid())
  name        String
  role        String?
  phone       String?
  email       String?
  type        PayrollEmployeeType @default(FIJA)
  weeklySalaryUSD Decimal?        @db.Decimal(10, 2)
  active      Boolean             @default(true)
  notes       String?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  payments    PayrollPayment[]
  carpentryTasks CarpentryTask[]
  carpentryProjectsAsCarpenter CarpentryProject[] @relation("ProjectCarpenter")
  carpentryProjectsAsArchitect CarpentryProject[] @relation("ProjectArchitect")
  carpentryProjectsAsSupervisor CarpentryProject[] @relation("ProjectSupervisor")
  productionOrdersAsCarpentryLead ProductionOrder[] @relation("ProductionCarpenter")
  productionOrdersAsSupervisor ProductionOrder[] @relation("ProductionSupervisor")
}

model PayrollPayment {
  id            String               @id @default(cuid())
  employeeId    String?
  employee      PayrollEmployee?     @relation(fields: [employeeId], references: [id], onDelete: SetNull)
  category      PayrollPaymentCategory @default(OTRO)
  amountUSD     Decimal              @db.Decimal(12, 2)
  paidAt        DateTime             @default(now())
  method        PaymentMethod?
  reference     String?
  description   String?
  service       String?
  createdAt     DateTime             @default(now())

  projectId     String?
  project       CarpentryProject?    @relation(fields: [projectId], references: [id], onDelete: SetNull)
  projectPhase  CarpentryProjectPhase?

  @@index([employeeId])
  @@index([category, paidAt])
  @@index([projectId])
}

// Proyectos de carpinteria
model CarpentryProject {
  id                 String                 @id @default(cuid())
  name               String
  clientName         String?
  clientEmail        String?
  clientPhone        String?
  clientAddress      String?
  clientCity         String?
  clientState        String?
  description        String?
  totalAmountUSD     Decimal                @db.Decimal(12, 2)
  initialPaymentUSD  Decimal?               @db.Decimal(12, 2)
  laborCostUSD       Decimal?               @db.Decimal(12, 2)
  fabricationPct     Decimal                @default(70) @db.Decimal(5, 2)
  installationPct    Decimal                @default(30) @db.Decimal(5, 2)
  fabricationPaidUSD Decimal                @default(0) @db.Decimal(12, 2)
  installationPaidUSD Decimal               @default(0) @db.Decimal(12, 2)
  status             CarpentryProjectStatus @default(ACTIVO)
  startDate          DateTime?
  endDate            DateTime?
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt

  carpenterId        String?
  carpenter          PayrollEmployee?       @relation("ProjectCarpenter", fields: [carpenterId], references: [id], onDelete: SetNull)
  architectId        String?
  architect          PayrollEmployee?       @relation("ProjectArchitect", fields: [architectId], references: [id], onDelete: SetNull)
  supervisorId       String?
  supervisor         PayrollEmployee?       @relation("ProjectSupervisor", fields: [supervisorId], references: [id], onDelete: SetNull)

  files              CarpentryProjectFile[]
  tasks              CarpentryTask[]
  payments           PayrollPayment[]
  clientPayments     CarpentryClientPayment[]
  materialLists      CarpentryProjectMaterialList[]
  purchaseOrders     CarpentryProjectPurchaseOrder[]
  expenses           CarpentryProjectExpense[]
  productionOrders   ProductionOrder[]
}

model CarpentryProjectFile {
  id          String                   @id @default(cuid())
  projectId   String
  project     CarpentryProject         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  url         String
  filename    String?
  fileType    CarpentryProjectFileType @default(OTRO)
  createdAt   DateTime                 @default(now())

  @@index([projectId])
}

model CarpentryProjectMaterialList {
  id          String        @id @default(cuid())
  projectId   String
  project     CarpentryProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name        String
  description String?
  fileUrl     String
  uploadedAt  DateTime      @default(now())
  items       CarpentryProjectMaterial[]

  @@index([projectId])
}

model CarpentryProjectMaterial {
  id            String  @id @default(cuid())
  listId        String
  list          CarpentryProjectMaterialList @relation(fields: [listId], references: [id], onDelete: Cascade)
  sku           String?
  name          String
  category      String?
  unit          String?
  quantity      Int     @default(0)
  unitPriceUSD  Decimal @db.Decimal(12, 2)

  @@index([listId])
}

model CarpentryProjectPurchaseOrder {
  id              String    @id @default(cuid())
  projectId       String
  project         CarpentryProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  saleId          String?
  totalUSD        Decimal   @db.Decimal(12, 2)
  status          ProjectPurchaseStatus @default(PENDING)
  requiresSecret  Boolean   @default(false)
  secretToken     String?
  notes           String?
  createdAt       DateTime  @default(now())

  @@index([projectId])
}

model CarpentryProjectExpense {
  id             String    @id @default(cuid())
  projectId      String
  project        CarpentryProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  provider       String
  invoiceNumber  String?
  description    String
  expenseType    ExpenseType
  date           DateTime
  quantity       Int      @default(1)
  unitCostUSD    Decimal  @db.Decimal(12, 2)
  totalCostUSD   Decimal  @db.Decimal(12, 2)
  receiptUrl     String?
  createdById    String?
  createdAt      DateTime @default(now())

  @@index([projectId])
}

model ProductionOrder {
  id             String    @id @default(cuid())
  projectId      String
  project        CarpentryProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  number         String    @unique
  carpentryLeadId String?
  carpentryLead  PayrollEmployee? @relation("ProductionCarpenter", fields: [carpentryLeadId], references: [id], onDelete: SetNull)
  supervisorId   String?
  supervisor     PayrollEmployee? @relation("ProductionSupervisor", fields: [supervisorId], references: [id], onDelete: SetNull)
  phase          CarpentryProjectPhase?
  scheduledStart DateTime?
  scheduledEnd   DateTime?
  installDate    DateTime?
  status         ProductionStatus @default(PLANNED)
  progressPct    Decimal   @db.Decimal(5, 2) @default(0)
  notes          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  tasks          CarpentryTask[] @relation("ProductionTasks")

  @@index([projectId])
}

enum ProjectPurchaseStatus {
  PENDING
  APPROVED
  DELIVERED
  CANCELLED
}

enum ExpenseType {
  FLETE
  EXTRA
  MATERIAL
  OTRO
}

enum ProductionStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  ON_HOLD
}

model CarpentryTask {
  id          String                 @id @default(cuid())
  employeeId  String
  employee    PayrollEmployee        @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  projectId   String?
  project     CarpentryProject?      @relation(fields: [projectId], references: [id], onDelete: SetNull)
  description String
  workDate    DateTime               @default(now())
  amountUSD   Decimal                @default(0) @db.Decimal(12, 2)
  phase       CarpentryProjectPhase?
  status      CarpentryTaskStatus    @default(PENDIENTE)
  createdAt   DateTime               @default(now())
  productionOrderId String?
  productionOrder   ProductionOrder?  @relation("ProductionTasks", fields: [productionOrderId], references: [id], onDelete: SetNull)

  @@index([employeeId])
  @@index([projectId])
}

model CarpentryClientPayment {
  id          String        @id @default(cuid())
  projectId   String
  project     CarpentryProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  amountUSD   Decimal       @db.Decimal(12, 2)
  paidAt      DateTime      @default(now())
  method      PaymentMethod?
  reference   String?
  notes       String?
  proofUrl    String?
  createdAt   DateTime      @default(now())

  @@index([projectId])
  @@index([paidAt])
}

// Token para confirmar órdenes por WhatsApp
model OrderAuthToken {
  id          String    @id @default(cuid())
  orderId     String
  order       Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  token       String
  expiresAt   DateTime
  usedAt      DateTime?
  createdAt   DateTime  @default(now())
  channel     String?
  destination String?

  @@unique([orderId, token])
}

model OrdersTemp {
  id           String   @id @default(cuid())
  customerId   String
  items        Json
  totalUSD     Decimal  @db.Decimal(10, 2)
  shippingData Json?
  createdAt    DateTime @default(now())
}

model PurchaseToken {
  id          String   @id @default(cuid())
  customerId  String
  orderTempId String
  token       String
  expiresAt   DateTime
  used        Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([customerId])
  @@index([orderTempId, token])
}
